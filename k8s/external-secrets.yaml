---
# =============================================================================
# External Secrets Operator -- AWS Secrets Manager Integration
# =============================================================================
#
# Prerequisites:
#   1. Install the External Secrets Operator:
#      helm repo add external-secrets https://charts.external-secrets.io
#      helm install external-secrets external-secrets/external-secrets \
#        -n external-secrets --create-namespace
#
#   2. Create an IAM role (or user) with SecretsManager read access and
#      configure authentication (IRSA, kiam, or static credentials).
#
#   3. Create the required secrets in AWS Secrets Manager:
#      - devplatform/prod/db
#      - devplatform/prod/jwt
#      - devplatform/prod/s3
#      - devplatform/prod/api-keys
#      - devplatform/prod/sentry
#
# Usage:
#   kubectl apply -f k8s/external-secrets.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# ClusterSecretStore -- AWS Secrets Manager (shared across namespaces)
# -----------------------------------------------------------------------------
# If you prefer namespace-scoped access, change kind to SecretStore and move
# into the devplatform namespace.
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app.kubernetes.io/name: aws-secrets-manager
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: 3d-development-platform
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      # -------------------------------------------------------------------
      # Authentication -- choose ONE of the methods below.
      # -------------------------------------------------------------------

      # Option A: IAM Roles for Service Accounts (IRSA) -- recommended for EKS
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets

      # Option B: Static credentials (not recommended for production)
      # Uncomment below and comment out the jwt block above.
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       namespace: external-secrets
      #       key: access-key-id
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       namespace: external-secrets
      #       key: secret-access-key

---
# -----------------------------------------------------------------------------
# ExternalSecret -- Main application secrets
# -----------------------------------------------------------------------------
# Syncs secrets from AWS Secrets Manager into a native Kubernetes Secret
# named "devplatform-secrets" in the "devplatform" namespace.
# This matches the existing secretKeyRef names used in k8s/backend.yaml.
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: devplatform-secrets
  namespace: devplatform
  labels:
    app.kubernetes.io/name: devplatform-secrets
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: 3d-development-platform
spec:
  refreshInterval: 1h       # How often to poll AWS for updated values
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: devplatform-secrets     # Name of the k8s Secret to create/update
    creationPolicy: Owner         # ESO owns the Secret lifecycle
    deletionPolicy: Retain        # Keep the Secret if the ExternalSecret is deleted
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: devplatform-secrets
          app.kubernetes.io/component: configuration
          app.kubernetes.io/part-of: 3d-development-platform

  data:
    # ------------------------------------------------------------------
    # JWT Secret Key
    # Source: devplatform/prod/jwt  ->  {"secret_key": "..."}
    # ------------------------------------------------------------------
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: devplatform/prod/jwt
        property: secret_key

    # ------------------------------------------------------------------
    # Database Credentials
    # Source: devplatform/prod/db  ->  {"username": "...", "password": "..."}
    # ------------------------------------------------------------------
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: devplatform/prod/db
        property: password

    - secretKey: POSTGRES_USER
      remoteRef:
        key: devplatform/prod/db
        property: username

    # ------------------------------------------------------------------
    # S3 / MinIO Credentials
    # Source: devplatform/prod/s3  ->  {"access_key": "...", "secret_key": "...",
    #         "minio_root_user": "...", "minio_root_password": "..."}
    # ------------------------------------------------------------------
    - secretKey: S3_ACCESS_KEY
      remoteRef:
        key: devplatform/prod/s3
        property: access_key

    - secretKey: S3_SECRET_KEY
      remoteRef:
        key: devplatform/prod/s3
        property: secret_key

    - secretKey: MINIO_ROOT_USER
      remoteRef:
        key: devplatform/prod/s3
        property: minio_root_user

    - secretKey: MINIO_ROOT_PASSWORD
      remoteRef:
        key: devplatform/prod/s3
        property: minio_root_password

    # ------------------------------------------------------------------
    # API Keys
    # Source: devplatform/prod/api-keys  ->  {"anthropic_api_key": "...",
    #         "mapbox_access_token": "..."}
    # ------------------------------------------------------------------
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: devplatform/prod/api-keys
        property: anthropic_api_key

    - secretKey: MAPBOX_ACCESS_TOKEN
      remoteRef:
        key: devplatform/prod/api-keys
        property: mapbox_access_token

    # ------------------------------------------------------------------
    # Sentry DSN (Monitoring)
    # Source: devplatform/prod/sentry  ->  {"backend_dsn": "...",
    #         "frontend_dsn": "..."}
    # ------------------------------------------------------------------
    - secretKey: SENTRY_DSN
      remoteRef:
        key: devplatform/prod/sentry
        property: backend_dsn

    - secretKey: SENTRY_DSN_FRONTEND
      remoteRef:
        key: devplatform/prod/sentry
        property: frontend_dsn

---
# -----------------------------------------------------------------------------
# ExternalSecret -- Database connection strings (composed from credentials)
# -----------------------------------------------------------------------------
# Uses templating to build full connection strings from the database secret.
# This avoids storing full URLs in AWS Secrets Manager.
# -----------------------------------------------------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: devplatform-db-urls
  namespace: devplatform
  labels:
    app.kubernetes.io/name: devplatform-db-urls
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: 3d-development-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore

  target:
    name: devplatform-db-urls
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        DATABASE_URL: "postgresql+asyncpg://{{ .db_user }}:{{ .db_pass }}@postgres:5432/dev_platform"
        DATABASE_URL_SYNC: "postgresql://{{ .db_user }}:{{ .db_pass }}@postgres:5432/dev_platform"

  data:
    - secretKey: db_user
      remoteRef:
        key: devplatform/prod/db
        property: username

    - secretKey: db_pass
      remoteRef:
        key: devplatform/prod/db
        property: password

---
# -----------------------------------------------------------------------------
# ServiceAccount for IRSA (IAM Roles for Service Accounts)
# -----------------------------------------------------------------------------
# Annotate this ServiceAccount with the IAM role ARN that has
# SecretsManager:GetSecretValue permission on devplatform/* secrets.
#
# Create the IAM role:
#   aws iam create-role --role-name ExternalSecretsDevplatform \
#     --assume-role-policy-document file://trust-policy.json
#
#   aws iam put-role-policy --role-name ExternalSecretsDevplatform \
#     --policy-name SecretsManagerReadOnly \
#     --policy-document '{
#       "Version": "2012-10-17",
#       "Statement": [{
#         "Effect": "Allow",
#         "Action": [
#           "secretsmanager:GetSecretValue",
#           "secretsmanager:DescribeSecret"
#         ],
#         "Resource": "arn:aws:secretsmanager:us-east-1:ACCOUNT_ID:secret:devplatform/*"
#       }]
#     }'
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets-sa
    app.kubernetes.io/component: secret-store
    app.kubernetes.io/part-of: 3d-development-platform
  annotations:
    # Replace ACCOUNT_ID with your AWS account ID
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/ExternalSecretsDevplatform"
